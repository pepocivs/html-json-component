<!--
@license
Copyright (c) 2018 Jorge Martín Martí (@pepocivs). All rights reserved.
This code may only be used under the MIT style license found at https://raw.githubusercontent.com/pepocivs/html-json-component/master/LICENSE.txt
-->

<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="html-json-component">
  <template>
    <style>
      :host {
        display: block;
      }
      li, ul {
        list-style: none;
        margin: 3px 0px;
      }
      .html-json_key, .html-json_value {
        border-radius: 10px;
        padding: 0px 10px;
        margin: 3px;
      }
      .html-json_key {
        font-weight: bold;
        color: #31708f;
        background-color: #d9edf7;
        border: 1px solid #bce8f1;
      }
      .html-json_value {
        color: #3c763d;
        background-color: #dff0d8;
        border: 1px solid #d6e9c6;
      }
    </style>
    <h2>JSON - HTML Printer</h2>
    <div id="printer"></div>
  </template>

  <script>
    /**
     * `html-json-component`
     * JSON beautifier component for polymer
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class HtmlJsonComponent extends (class extends Polymer.Element {}) {
      static get is() { return 'html-json-component'; }
      static get properties() {
        return {
          json: {
            type: Object,
            notify: true,
            observer: '_convertJSON'
          },
          print: {
            type: Boolean,
            value: true
          },
          equivalences: {
            type: Object,
            notify: true
          },
          output: String
        };
      }

      _convertJSON() {
        if (!this.equivalences || !this.json) return false;
        try {
          const parsedJson = this._strToJson(this.json);          
          this._print(this.jsonBeautifier(parsedJson, ''));
        } catch (error) { console.error(error); }
      }

      _print(html) {
        if (!this.print) return false;
        const docPlace = this.$.printer;
        const containerHTML = document.createElement('div');
        containerHTML.innerHTML = html;
        docPlace.appendChild(containerHTML);
      }

      jsonBeautifier(json, parentKey) {
        console.log('jsonBeautifier', parentKey);
        let html = '';
        html += (json.length === undefined) ?
        this._fillData(Object.keys(json), html, json) :
        this._fillData(json, html, this.currentJson);
        return html;
      }
      _fillData(json, html, currentJson) {
        console.log('_fillData', json, currentJson);
        this.currentJson = currentJson || json;
        return `${html}${json.map(this._fillRow, this).join('')}<br />`;
      }
      _fillRow(objectKey, index) {
        let html = '';
        if (objectKey === 'hobbies') debugger;
        if (typeof objectKey === 'object') html += this.jsonBeautifier(objectKey, index);
        else {
          const key = this._strToJson(this.equivalences)[objectKey] || objectKey;
          const value = (this.currentJson[index] && this.currentJson[index].length) ?
            this.currentJson[index] :
            this.currentJson[objectKey];
          let parsedValue = (value === key) ? '' : value;
          switch (typeof value) {
            case 'object':
              html += `<li>
                        <span class="html-json_key">${key}</span>
                        <ul>${this.jsonBeautifier(value, key)}</ul>
                      </li>`;
              break;
            case 'boolean':
              parsedValue = (value === true) ? 'Yes' : 'No';
              html += `<li>
                        <span class="html-json_key">${key}</span>
                        <span class="html-json_value">${parsedValue}</span>
                      </li>`;
              break;
            default:
              if (value === key) {
                html += `<li>
                          <span class="html-json_value">${value}</span>
                        </li>`;
              } else if (!value) {
                html += `<li>
                          <span class="html-json_value">${key}</span>
                        </li>`;
              } else {
                html += `<li>
                          <span class="html-json_key">${key}</span>
                          <span class="html-json_value">${parsedValue}</span>
                        </li>`;
              }
              break;
          }
        }
        return html;
      }

      //** Helper Functions */
      _strToJson(str) {
        if (typeof str !== 'string') return str;
        const validString = str.replace(/'/g, '"');
        return JSON.parse(validString);
      }
    }

    window.customElements.define(HtmlJsonComponent.is, HtmlJsonComponent);
  </script>
</dom-module>
